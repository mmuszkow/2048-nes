#include <nes.h>
#include "neslib.h"

#define COL_1    0x11
#define COL_2    0x16
#define COL_3    0x29

#define NOTIFY_COL 0x30

static const unsigned char PALETTE[32] = {
    // background palette
    0x0E,COL_1,COL_2,COL_3,0x0E,0x1D,0x2D,0x3D,0x0E,COL_1,COL_2,COL_3,0x0E,COL_1,COL_2,COL_3,
    // sprite palette
    0x0E,COL_1,NOTIFY_COL,COL_3,0x0E,COL_1,COL_2,COL_3,0x0E,COL_1,COL_2,COL_3,0x0E,COL_1,COL_2,COL_3
};

// start screen
static const unsigned char BKG0[1024] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x39,0x2F,0x35,0x32,0x00,0x2F,0x22,0x2A,0x25,0x23,0x34,0x29,0x36,0x25,0x3C,0x00,0x27,0x25,0x34,0x00,0x34,0x2F,0x00,0x34,0x28,0x25,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x0A,0x09,0x09,0x09,0x06,0x00,0x00,0x00,0x08,0x09,0x09,0x09,0x06,0x00,0x00,0x08,0x06,0x00,0x00,0x00,0x08,0x06,0x00,0x00,0x08,0x09,0x09,0x09,0x06,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x04,0x06,0x00,0x08,0x03,0x00,0x00,0x00,0x04,0x06,0x00,0x04,0x03,0x00,0x00,0x00,0x04,0x03,0x00,0x08,0x03,0x00,0x00,0x00,0x04,0x06,0x00,
    0x00,0x00,0x00,0x00,0x00,0x04,0x05,0x00,0x04,0x03,0x00,0x00,0x00,0x04,0x03,0x00,0x04,0x03,0x00,0x00,0x00,0x04,0x03,0x00,0x07,0x03,0x00,0x00,0x00,0x04,0x05,0x00,
    0x00,0x00,0x08,0x09,0x09,0x05,0x00,0x00,0x04,0x03,0x00,0x00,0x00,0x04,0x03,0x00,0x07,0x01,0x09,0x09,0x09,0x00,0x03,0x00,0x00,0x04,0x09,0x09,0x09,0x03,0x00,0x00,
    0x00,0x08,0x03,0x00,0x00,0x00,0x00,0x00,0x04,0x03,0x00,0x00,0x00,0x04,0x03,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x03,0x00,0x08,0x03,0x00,0x00,0x00,0x04,0x06,0x00,
    0x00,0x04,0x03,0x00,0x00,0x00,0x00,0x00,0x07,0x03,0x00,0x00,0x00,0x04,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x04,0x03,0x00,0x07,0x03,0x00,0x00,0x00,0x04,0x05,0x00,
    0x00,0x07,0x01,0x09,0x09,0x09,0x0B,0x00,0x00,0x07,0x09,0x09,0x09,0x05,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x07,0x05,0x00,0x00,0x07,0x09,0x09,0x09,0x05,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x34,0x29,0x2C,0x25,0x3E,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x30,0x32,0x25,0x33,0x33,0x00,0x33,0x34,0x21,0x32,0x34,0x00,0x34,0x2F,0x00,0x22,0x25,0x27,0x29,0x2E,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x30,0x32,0x25,0x33,0x33,0x00,0x33,0x25,0x2C,0x25,0x23,0x34,0x00,0x34,0x2F,0x00,0x2D,0x35,0x34,0x25,0x00,0x2D,0x35,0x33,0x29,0x23,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x2D,0x2D,0x35,0x33,0x3A,0x2B,0x2F,0x37,0x3B,0x12,0x10,0x11,0x15,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // attributes
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};
// game screen
static const unsigned char BKG1[1024] = {
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x01,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x08,0x02,0x02,0x02,0x02,0x06,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,0x03,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x03,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x07,0x01,0x01,0x01,0x01,0x05,0x04,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x02,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
    // attributes
    0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x55, 0x05,
    0x55, 0x00, 0x11, 0x44, 0x00, 0x11, 0x44, 0x55,
    0x55, 0x05, 0x15, 0x45, 0x05, 0x15, 0x45, 0x55,
    0x55, 0x50, 0x51, 0x54, 0x50, 0x51, 0x54, 0x55,
    0x55, 0x00, 0x11, 0x44, 0x00, 0x11, 0x44, 0x55,
    0x55, 0x05, 0x15, 0x45, 0x05, 0x15, 0x45, 0x55,
    0x55, 0x50, 0x51, 0x54, 0x50, 0x51, 0x54, 0x55,
    0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00
};

#define MAP_W    4
#define MAP_H    4
#define MAP_SIZE 16
#define MAP_VAL(x) ((x)&0xF)
#define NOTIFY_FLAG 0xF0
#define MAP_GET_NOTIFY(x) (((x)&NOTIFY_FLAG)>>4)
#define MAP_SET_NOTIFY(x, y, val) { map[y][x] &= ~NOTIFY_FLAG; map[y][x] |= ((val)<<4); }
// hi 4 bits - how long should the notification of change be displayed
// lo 4 bits - value (0-11)
static unsigned char map[MAP_H][MAP_W];
static unsigned char prev_map[MAP_H][MAP_W] = {{0,0,0,0},{0,0,0,0},{0,0,0,0},{0,0,0,0}};

// used by drawing funcs
static unsigned char vram_buff[49];
// address variable
static unsigned int addr;

// redraws single tile - 1 frame
void __fastcall__ redraw_tile(unsigned char y, unsigned char x) {    
    static unsigned char k, z, val, sprite, msb, lsb;

    val = MAP_VAL(map[y][x]);
    sprite = val<<2;
    if(val > 7) sprite += 0xA0;
    else if(val > 3) sprite += 0x70;
    else sprite += 0x40;
    
    z = 0;
    addr = NTADR_C(4+x*6, 4+y*6); 
    for(k=0; k<4; k++) {
        msb = MSB(addr); lsb = LSB(addr);
        vram_buff[z++] = msb;
        vram_buff[z++] = lsb++;
        vram_buff[z++] = sprite;
        vram_buff[z++] = msb;
        vram_buff[z++] = lsb++;
        vram_buff[z++] = sprite+1;
        vram_buff[z++] = msb;
        vram_buff[z++] = lsb++;
        vram_buff[z++] = sprite+2;
        vram_buff[z++] = msb;
        vram_buff[z++] = lsb++;
        vram_buff[z++] = sprite+3;
        sprite += 0x10; // next line in sprites
        addr += 32; // 32 cols per row
    }
    vram_buff[z] = NT_UPD_EOF;    
    set_vram_update(vram_buff);
    ppu_wait_nmi();
}

// shows text on the right edge of the screen - 2 frames
void __fastcall__ show_msg(char* msg) {
    static unsigned char i, len;
    len = 0; // len
    addr = NTADR_C(29, 5); 
    vram_buff[0] = MSB(addr)|NT_UPD_VERT;
    vram_buff[1] = LSB(addr);
    i = 3;
    while(*msg) {
        vram_buff[i++] = (*msg++)-0x20;
        len++;
    }
    vram_buff[2] = len;
    vram_buff[i] = NT_UPD_EOF;    
    set_vram_update(vram_buff);
    ppu_wait_nmi();
    set_vram_update(NULL);
}

// counts empty cells
unsigned char __fastcall__ count_empty(void) {
    static unsigned char i, j, count;
    count = 0;
    for(i=0; i<MAP_H; i++)
        for(j=0; j<MAP_W; j++)
            if(MAP_VAL(map[i][j]) == 0) count++;
    return count;
}

// adds new cell to map (if possible)
unsigned char __fastcall__ add_cell(void) {
    static unsigned char i, j, count, index, counter;
    // check if there are free fields
    count = count_empty();    
    if(count == 0) return 0;
    
    // if yes, mark random with "2"
    index = rand8() % count;
    counter = 0;
    for(i=0; i<MAP_H; i++)
        for(j=0; j<MAP_W; j++) {
            if(MAP_VAL(map[i][j]) == 0) {
                if(index == counter) {
                    if(rand8()<=230)
                        map[i][j] = NOTIFY_FLAG|1; // "2"
                    else
                        map[i][j] = NOTIFY_FLAG|2; // "4"
                    return 1;
                } else
                    counter++;
            }
        }
    return 0;
}

// long method, but I couldn't make better using loops...
unsigned char __fastcall__ move(unsigned char direction) {
    static unsigned char i, j, ret;
    ret = 0;
    // make a copy of the current map to later redraw only those tiles that changed
    memcpy(prev_map, map, MAP_SIZE);
    switch(direction) {
        case PAD_LEFT:
            for(i=0; i<MAP_H; i++) {
                // put first right on col 1
                while(MAP_VAL(map[i][0]) == 0 && (MAP_VAL(map[i][1]) != 0 || MAP_VAL(map[i][2]) != 0 || MAP_VAL(map[i][3]) != 0)) {
                    map[i][0] = map[i][1];
                    map[i][1] = map[i][2];
                    map[i][2] = map[i][3];
                    map[i][3] = 0;
                    ret = 1;
                }
                // put first right on col 2
                while(MAP_VAL(map[i][1]) == 0 && (MAP_VAL(map[i][2]) != 0 || MAP_VAL(map[i][3]) != 0)) {
                    map[i][1] = map[i][2];
                    map[i][2] = map[i][3];
                    map[i][3] = 0;
                    ret = 1;
                }
                // put next right on col 3
                if(MAP_VAL(map[i][2]) == 0 && MAP_VAL(map[i][3]) != 0) {
                    map[i][2] = map[i][3];
                    map[i][3] = 0;
                    ret = 1;
                }
                // merge first possible
                if(MAP_VAL(map[i][0]) != 0 && MAP_VAL(map[i][1]) == MAP_VAL(map[i][0])) {
                    map[i][0]++;
                    map[i][0] |= NOTIFY_FLAG;
                    map[i][1] = map[i][2];
                    map[i][2] = map[i][3];
                    map[i][3] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[i][1]) != 0 && MAP_VAL(map[i][2]) == MAP_VAL(map[i][1])) {
                    map[i][1]++;
                    map[i][1] |= NOTIFY_FLAG;
                    map[i][2] = map[i][3];
                    map[i][3] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[i][2]) != 0 && MAP_VAL(map[i][3]) == MAP_VAL(map[i][2])) {
                    map[i][2]++;
                    map[i][2] |= NOTIFY_FLAG;
                    map[i][3] = 0;
                    ret = 1;
                }
            }
            break;
        case PAD_RIGHT:
            for(i=0; i<MAP_H; i++) {
                // put first right on col 4
                while(MAP_VAL(map[i][3]) == 0 && (MAP_VAL(map[i][2]) != 0 || MAP_VAL(map[i][1]) != 0 || MAP_VAL(map[i][0]) != 0)) {
                    map[i][3] = map[i][2];
                    map[i][2] = map[i][1];
                    map[i][1] = map[i][0];
                    map[i][0] = 0;
                    ret = 1;
                }
                // put first right on col 3
                while(MAP_VAL(map[i][2]) == 0 && (MAP_VAL(map[i][1]) != 0 || MAP_VAL(map[i][0]) != 0)) {
                    map[i][2] = map[i][1];
                    map[i][1] = map[i][0];
                    map[i][0] = 0;
                    ret = 1;
                }
                // put next right on col 2
                if(MAP_VAL(map[i][1]) == 0 && MAP_VAL(map[i][0]) != 0) {
                    map[i][1] = map[i][0];
                    map[i][0] = 0;
                    ret = 1;
                }
                // merge first possible
                if(MAP_VAL(map[i][3]) != 0 && MAP_VAL(map[i][2]) == MAP_VAL(map[i][3])) {
                    map[i][3]++;
                    map[i][3] |= NOTIFY_FLAG;
                    map[i][2] = map[i][1];
                    map[i][1] = map[i][0];
                    map[i][0] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[i][2]) != 0 && MAP_VAL(map[i][1]) == MAP_VAL(map[i][2])) {
                    map[i][2]++;
                    map[i][2] |= NOTIFY_FLAG;
                    map[i][1] = map[i][0];
                    map[i][0] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[i][1]) != 0 && MAP_VAL(map[i][0]) == MAP_VAL(map[i][1])) {
                    map[i][1]++;
                    map[i][1] |= NOTIFY_FLAG;
                    map[i][0] = 0;
                    ret = 1;
                }
            }
            break;
        case PAD_UP:
            for(j=0; j<MAP_W; j++) {
                // put first under on row 1
                while(MAP_VAL(map[0][j]) == 0 && (MAP_VAL(map[1][j]) != 0 || MAP_VAL(map[2][j]) != 0 || MAP_VAL(map[3][j]) != 0)) {
                    map[0][j] = map[1][j];
                    map[1][j] = map[2][j];
                    map[2][j] = map[3][j];
                    map[3][j] = 0;
                    ret = 1;
                }
                // put first right on col 2
                while(MAP_VAL(map[1][j]) == 0 && (MAP_VAL(map[2][j]) != 0 || MAP_VAL(map[3][j]) != 0)) {
                    map[1][j] = map[2][j];
                    map[2][j] = map[3][j];
                    map[3][j] = 0;
                    ret = 1;
                }
                // put next right on col 3
                if(MAP_VAL(map[2][j]) == 0 && MAP_VAL(map[3][j]) != 0) {
                    map[2][j] = map[3][j];
                    map[3][j] = 0;
                    ret = 1;
                }
                // merge first possible
                if(MAP_VAL(map[0][j]) != 0 && MAP_VAL(map[1][j]) == MAP_VAL(map[0][j])) {
                    map[0][j]++;
                    map[0][j] |= NOTIFY_FLAG;
                    map[1][j] = map[2][j];
                    map[2][j] = map[3][j];
                    map[3][j] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[1][j]) != 0 && MAP_VAL(map[2][j]) == MAP_VAL(map[1][j])) {
                    map[1][j]++;
                    map[1][j] |= NOTIFY_FLAG;
                    map[2][j] = map[3][j];
                    map[3][j] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[2][j]) != 0 && MAP_VAL(map[3][j]) == MAP_VAL(map[2][j])) {
                    map[2][j]++;
                    map[2][j] |= NOTIFY_FLAG;
                    map[3][j] = 0;
                    ret = 1;
                }
            }
            break;
        case PAD_DOWN:
            for(j=0; j<MAP_W; j++) {
                // put first under on row 4
                while(MAP_VAL(map[3][j]) == 0 && (MAP_VAL(map[2][j]) != 0 || MAP_VAL(map[1][j]) != 0 || MAP_VAL(map[0][j]) != 0)) {
                    map[3][j] = map[2][j];
                    map[2][j] = map[1][j];
                    map[1][j] = map[0][j];
                    map[0][j] = 0;
                    ret = 1;
                }
                // put first right on row 3
                while(MAP_VAL(map[2][j]) == 0 && (MAP_VAL(map[1][j]) != 0 || MAP_VAL(map[0][j]) != 0)) {
                    map[2][j] = map[1][j];
                    map[1][j] = map[0][j];
                    map[0][j] = 0;
                    ret = 1;
                }
                // put next right on row 2
                if(MAP_VAL(map[1][j]) == 0 && MAP_VAL(map[0][j]) != 0) {
                    map[1][j] = map[0][j];
                    map[0][j] = 0;
                    ret = 1;
                }
                // merge first possible
                if(MAP_VAL(map[3][j]) != 0 && MAP_VAL(map[2][j]) == MAP_VAL(map[3][j])) {
                    map[3][j]++;
                    map[3][j] |= NOTIFY_FLAG;
                    map[2][j] = map[1][j];
                    map[1][j] = map[0][j];
                    map[0][j] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[2][j]) != 0 && MAP_VAL(map[1][j]) == MAP_VAL(map[2][j])) {
                    map[2][j]++;
                    map[3][j] |= NOTIFY_FLAG;
                    map[1][j] = map[0][j];
                    map[1][j] = 0;
                    ret = 1;
                } else if(MAP_VAL(map[1][j]) != 0 && MAP_VAL(map[0][j]) == MAP_VAL(map[1][j])) {
                    map[1][j]++;
                    map[1][j] |= NOTIFY_FLAG;
                    map[0][j] = 0;
                    ret = 1;
                }
            }
            break;            
    }
    return ret;
}

// shows single frame of notification, returns 0 if no notifications left
void __fastcall__ show_point_notification(void) {
    static unsigned char i, j, oam_buff, notify, x, y;
    oam_buff = 0;
    y = 24;
    for(i=0; i<MAP_H; i++) {
        x = 32;
        for(j=0; j<MAP_W; j++) {
            notify = MAP_GET_NOTIFY(map[i][j]);
            if(notify) {
                oam_buff = oam_spr(x-4, y, 0x1A, 0, oam_buff);
                oam_buff = oam_spr(x+4, y, 0x1B, 0, oam_buff);
                MAP_SET_NOTIFY(j, i, notify-1);
            } else {
                oam_buff = oam_spr(0, 0, 0, 0, oam_buff);
                oam_buff = oam_spr(0, 0, 0, 0, oam_buff);
            }
            x += 48;
        }
        y += 48;
    }
    //ppu_wait_nmi();
}

#define NO_CHANGE 0
#define GAME_LOST 1
#define GAME_WON  2

// checks if you lost or won the game
unsigned char __fastcall__ check_state(void) {
    static unsigned char i, j;
    if(count_empty() != 0) return NO_CHANGE;
    for(i=0; i<MAP_H; i++)
        for(j=0; j<MAP_W; j++)
            if(MAP_VAL(map[i][j]) == 11) return GAME_WON; // "2048"
    for(i=0; i<MAP_H-1; i++)
        for(j=0; j<MAP_W; j++)
            if(MAP_VAL(map[i][j]) == MAP_VAL(map[i+1][j])) return NO_CHANGE;
    for(i=0; i<MAP_H; i++)
        for(j=0; j<MAP_W-1; j++)
            if(MAP_VAL(map[i][j]) == MAP_VAL(map[i][j+1])) return NO_CHANGE;
    return GAME_LOST;
}

int main() {
    static unsigned char i, j, keys, keys_changed, has_changed, music_on, game_on;
    static unsigned int rseed;
    rseed = 0;
    keys_changed = 0;    

    // init graphics
    pal_all(PALETTE);
    vram_adr(NAMETABLE_A);
    vram_write(BKG0, 1024);
    vram_adr(NAMETABLE_C);
    vram_write(BKG1, 1024);
    oam_clear();
    ppu_on_all();
    
    music_on = 1;
    music_play(0);
    
    // wait for start button and scroll to game screen
    while(!(pad_poll(0) & PAD_START)) { rseed++; }
    set_rand(rseed);
    scroll(0, 240);
    
    // game itself
    while(1) {
        // re-init map
        game_on = 1;
        memfill(map, 0, MAP_SIZE);
        oam_clear();        
        add_cell();
        add_cell();
        show_msg("                     ");
        
        while(game_on) {
            // redraw changed tiles and displays notifications
            for(i=0; i<MAP_H; i++)
                for(j=0; j<MAP_W; j++)
                    if(MAP_VAL(map[i][j]) != MAP_VAL(prev_map[i][j]))
                        redraw_tile(i, j);
            set_vram_update(NULL);
            show_point_notification();
            
            switch(check_state()) {
                case NO_CHANGE:
                    // key down - single action
                    keys = pad_poll(0);
                    if(keys != keys_changed) {
                        has_changed = 0;
                        if(keys_changed & PAD_LEFT) has_changed = move(PAD_LEFT);
                        else if(keys_changed & PAD_RIGHT) has_changed = move(PAD_RIGHT);
                        else if(keys_changed & PAD_UP) has_changed = move(PAD_UP);
                        else if(keys_changed & PAD_DOWN) has_changed = move(PAD_DOWN);
                        else if(keys_changed & PAD_SELECT) { music_pause(music_on); music_on = music_on ? 0 : 1; }
                        if(has_changed) add_cell();
                        keys_changed = keys;                    
                    }
                    break;
                case GAME_LOST:
                    show_msg("YOU LOST  PRESS START");
                    while(!(pad_poll(0) & PAD_START));
                    game_on = 0;
                    break;
                case GAME_WON:
                    show_msg("YOU WON^  PRESS START");
                    while(!(pad_poll(0) & PAD_START));
                    game_on = 0;
                    break;
            }
        }
    }

    return 0;
}
